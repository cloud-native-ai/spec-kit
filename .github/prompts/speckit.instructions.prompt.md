> Note: `$ARGUMENTS` provides optional context or specific requirements for the instructions generation.

## Goal

Create or update the `.ai/instructions.md` file to serve as the single source of truth for AI agents (GitHub Copilot, Cline, etc.) working on this project. Establish necessary symlinks for compatibility.

## Execution Steps

### 1. Context Analysis
- Read `README.md` (project overview).
- Read `Makefile`, `pom.xml`, `pyproject.toml` or `package.json` (tech stack).
- Read `.specify/memory/constitution.md` (if exists) for core principles.

### 2. Instructions File Management
Check if `.ai/instructions.md` exists.
- **If YES**: Rename it to `.ai/instructions.md.bak`.
- **If NO**: Proceed to create.

Create `.ai/instructions.md` with the following structure. The content MUST be generated by analyzing the project, NOT by asking the user to fill it in.

````markdown
# Project Instructions for AI Agents

## Project Overview
[Brief summary of what the app does, its core value proposition, and key features based on README]

## Documentation Map
This project documentation is distributed across several key files. You MUST refer to these documents for specific details:

| Document | Location | Purpose | Key Content |
|----------|----------|---------|-------------|
| **Constitution** | `.specify/memory/constitution.md` | Single source of truth for principles | Coding standards, architectural rules, critical constraints |
| **API Docs** | `docs/api.md` (or detected path) | API Contract details | Endpoints, schemas, auth flows |
| **Guidelines** | `CONTRIBUTING.md` / `docs/guidelines.md` | Contributor guide | Workflow steps, PR requirements |
| **Feature Index** | `.specify/memory/feature-index.md` | Feature roadmap status | List of active/planned/implemented features |
| [Other Doc] | [Path] | [Purpose] | [Summary] |

> **Directive**: When answering questions or generating code, ALWAYS check the relevant document from the map above first.

## Tech Stack & Resources
[Detected tech stack from config files]
- **Languages**: [e.g. Python 3.9+]
- **Frameworks**: [e.g. FastAPI, React]
- **Build/Run**: [e.g. "Use `make run`", "Use `npm start`"]
- **Key Directories**:
  - `src/`: Source code
  - `tests/`: Test suite
  - [Other detected dirs]

# MCP Tools Usage Guide

## Tool Selection Strategy
- Prioritize using the `mcp_...` series of tools to query internal documents and code listed in the **Documentation Map**.
- Do not guess about architectural rules; verify them in the **Constitution**.
````

### 3. Compatibility Symlinks
Create directory structures and symlinks to ensure `.ai/instructions.md` is picked up by various tools.
Run the following commands (or equivalent):

```bash
# Ensure .ai directory exists
mkdir -p .ai

# Cline/Roo Code
mkdir -p .clinerules
ln -sf ../.ai/instructions.md .clinerules/project_rules.md

# GitHub Copilot
mkdir -p .github
ln -sf ../.ai/instructions.md .github/copilot-instructions.md

# Lingma
mkdir -p .lingma/rules
ln -sf ../../.ai/instructions.md .lingma/rules/project_rule.md

# Trae
mkdir -p .trae/rules
ln -sf ../../.ai/instructions.md .trae/rules/project_rules.md

# Qoder
mkdir -p .qoder
ln -sf ../.ai/instructions.md .qoder/project_rules.md
```

### 4. Ignore Files
Check if `.copilotignore` exists.
- If not, create it starting with `.gitignore` content (if available).
- Append the following specific ignores:
  ```text
  .clinerules/
  .github/
  .lingma/
  .trae/
  .qoder/
  ```

## Report
Confirm completion of `.ai/instructions.md` creation/update and list all created symlinks.